javascript:(async function(){function getCurrentGid(){const urlMatch=window.location.href.match(/gid=([0-9]+)/);return urlMatch?urlMatch[1]:'0';}function delay(ms){return new Promise(resolve=>setTimeout(resolve,ms));}function dispatchClick(e){try{e.dispatchEvent(new MouseEvent('mousedown',{bubbles:!0,cancelable:!0,view:window}));e.dispatchEvent(new MouseEvent('mouseup',{bubbles:!0,cancelable:!0,view:window}));e.dispatchEvent(new MouseEvent('click',{bubbles:!0,cancelable:!0,view:window}));return!0;}catch(t){return!1;}}function getActiveSheetName(){const e=document.querySelector('.docs-sheet-active-tab .docs-sheet-tab-name');return e?e.textContent.trim():'Name_NOT_FOUND';}function getClassKeyFromTitle(){const titleElem=document.getElementById('docs-title-input-label-inner');if(!titleElem)return null;const rawTitle=titleElem.textContent.trim().toLowerCase();const match=rawTitle.match(/(\d+)\s*[/-]?\s*(\d*)\s*класс/);let key=rawTitle.replace(/\s+|\/|-/g,'_').replace(/[^a-zA-Z0-9_\u0400-\u04FF]/g,'').substring(0,30);if(match){const major=match[1];const minor=match[2]||'1';key=`class${major}_${minor}`;}else if(rawTitle.startsWith('расписание')||rawTitle.startsWith('дз')){}return key;}function displayOutput(title,json){const w=window.open('','JSON Output','width=600,height=600,scrollbars=yes');if(!w)return alert('Не удалось открыть окно. Пожалуйста, разрешите всплывающие окна для этого сайта.');const html=`<!DOCTYPE html><html><head><title>${title}</title><style>body{font-family:monospace;white-space:pre-wrap;padding:15px;background:#f4f4f4;}.container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1);}h1{font-size:1.4em;margin-bottom:15px;}textarea{width:100%;height:400px;border:1px solid #ddd;padding:10px;box-sizing:border-box;resize:none;font-size:1em;}</style></head><body><div class="container"><h1>${title}</h1><textarea id="json-output" readonly>${json}</textarea><button onclick="document.getElementById('json-output').select();document.execCommand('copy');this.textContent='Скопировано!';setTimeout(()=>this.textContent='Копировать все',2000)">Копировать все</button><p style="margin-top:10px;font-size:0.9em;color:#666;">Теперь вы можете закрыть это окно и вставить код в settings.js.</p></div></body></html>`;w.document.write(html);w.document.close();}async function fullyAutomateGidCollection(){const sheetIdMatch=window.location.href.match(/\/d\/([a-zA-Z0-9_-]+)/);const sheetId=sheetIdMatch?sheetIdMatch[1]:'SheetId_NOT_FOUND';if(sheetId==='SheetId_NOT_FOUND'){console.error('Не удается найти ID Таблицы.');return;}const tabs=Array.from(document.querySelectorAll('.docs-sheet-tab[role="button"]')).filter(e=>e.id&&e.querySelector('.docs-sheet-tab-name'));if(tabs.length===0){console.error('Не удалось найти вкладки. Обновите страницу.');return;}const classKey=getClassKeyFromTitle();if(!classKey){console.error('Не удалось определить ключ класса из заголовка документа. Пожалуйста, убедитесь, что заголовок содержит класс (напр., "5-1 класс").');return;}const classOutput={};const tabCount=tabs.length;const maxAttempts=15;const delayMs=500;let currentGid=getCurrentGid();const activeSheetName=getActiveSheetName();const apiPlaceholder=`${classKey}_api`;classOutput[classKey]={sheetId:sheetId,api:apiPlaceholder};const defaultRange=prompt(`Введите диапазон по умолчанию для ДЗ (например, C3:C14):`,'C3')||'C3';if(!defaultRange)return;console.log(`\n\nСБОР ДАННЫХ КЛАССА ${classKey}...`);for(let i=0;i<tabCount;i++){const tabElement=tabs[i];const sheetName=tabElement.querySelector('.docs-sheet-tab-name').textContent.trim();let previousGid=currentGid;let shouldClick=!0;if(sheetName===activeSheetName&&i===0){shouldClick=!1;}if(shouldClick){if(!dispatchClick(tabElement)){console.error(`Сбой клика на "${sheetName}" Пропуск.`);continue;}let attempts=0;while(currentGid===previousGid&&attempts<maxAttempts){await delay(delayMs);currentGid=getCurrentGid();attempts++;}if(currentGid===previousGid){console.error(`❌ GID не обновился для "${sheetName}". Пропуск.`);continue;}}else{currentGid=getCurrentGid();}const key=sheetName.replace(/\s+|\/|-/g,'_').replace(/[^a-zA-Z0-9_\u0400-\u04FF]/g,'').substring(0,25);if(key){classOutput[classKey][key]={gid:currentGid,range:defaultRange,name:sheetName};}else{console.warn(`Не удалось создать ключ для "${sheetName}". Пропуск.`);}}const jsonOutput=JSON.stringify(classOutput,null,2);displayOutput(`Конфигурация класса ${classKey}`,jsonOutput);}fullyAutomateGidCollection();})();
